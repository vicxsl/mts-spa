<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.qisen.mts.spa.dao.MemberDao">

	<!-- 通过手机号码检测账号是否存在 -->
	<select id="check" resultType="com.qisen.mts.spa.model.entity.SpaMember"
		parameterType="com.qisen.mts.spa.model.entity.SpaMember">
		<![CDATA[
			select *  from  member 
		]]>
		<where>
			<![CDATA[
				 appid = #{appid} and openid = #{openid} 
			]]>
			<if test="eid != null and eid !=''">
				<![CDATA[
					and eid = #{eid} 
				]]>
			</if>
		</where>
	</select>

	<!--新增商品 -->
	<insert id="create" parameterType="com.qisen.mts.spa.model.entity.SpaMember">
		<![CDATA[
			insert into member(eid,appid,name,mobile,totalMoney,balance,createDate,openid,session_key,unionid,recommendThreeId,recommendTwoId,recommendOneId,status,avatarUrl) 
			values(#{eid},#{appid},#{name},#{mobile},#{totalMoney},#{balance},#{createDate},#{openid},#{session_key},#{unionid},#{recommendThreeId},#{recommendTwoId},#{recommendOneId},0,#{avatarUrl})
		]]>
	</insert>

	<!-- 删除账号 -->
	<delete id="delete" parameterType="com.qisen.mts.spa.model.entity.SpaMember">
		<![CDATA[
			delete from member
		]]>
		<where>
			<![CDATA[
				eid = #{eid} and appid = #{appid} and openid=#{openid}
			]]>
		</where>
	</delete>

	<update id="update" parameterType="com.qisen.mts.spa.model.entity.SpaMember">
		<![CDATA[
			update member
		]]>
		<set>
			<if test="name != null and name !=''">
				<![CDATA[
					 name = #{name},
				 ]]>
			</if>
		</set>
		<where>
			<![CDATA[
				 eid = #{eid} and appid = #{appid} and id = #{id}
			]]>
		</where>
	</update>



	<!-- 查询SPA商品列表 -->
	<select id="list" resultType="com.qisen.mts.spa.model.entity.SpaMember"
		parameterType="com.qisen.mts.spa.model.entity.SpaMember">
		<![CDATA[
			select * from member
		]]>
		<where>
			<![CDATA[
				eid = #{eid} and appid = #{appid}
			]]>
		</where>
	</select>

	<!-- 查询会员推荐人员集合 及其所带来的获利集合 -->
	<select id="profitLevelOne" resultType="com.qisen.mts.spa.model.entity.SpaMember" parameterType="com.qisen.mts.spa.model.entity.SpaMember">
	  select b.buyOpenid as openid,b.eid, b.name,b.createDate,sum(b.money) as balance from (select t.name,t.eid,a.createDate,t.buyOpenid,t.money FROM incomeDetails t ,
	     member a where t.buyOpenid = a.openid and t.eid = #{eid} and t.openid=#{openid} ) b group by b.buyOpenid, b.name,b.createDate
	</select>
	
	<select id="levelTwo" resultType="com.qisen.mts.spa.model.entity.SpaMember" parameterType="com.qisen.mts.spa.model.entity.SpaMember">
	  select b.openid,b.eid, b.name,b.createDate,sum(b.money) as balance from (select t.name,t.eid,a.createDate,t.openid,t.money FROM incomeDetails t ,
	     member a where t.openid = a.openid and t.eid = #{eid} and t.Level=1 and t.openid in
	     <foreach collection="list" item="member" index="index" open="("  separator="," close=")">
				<![CDATA[
					#{member.openid}
				]]>
			</foreach>
	      ) b group by b.openid, b.name,b.createDate
	</select>
	
	<select id="levelThree" resultType="com.qisen.mts.spa.model.entity.SpaMember" parameterType="com.qisen.mts.spa.model.entity.SpaMember">
	  select b.openid, b.name,b.eid,b.createDate,sum(b.money) as balance from (select t.name,t.eid,a.createDate,t.openid,t.money FROM incomeDetails t ,
	     member a where t.openid = a.openid and t.eid = #{eid} and t.Level=2 and t.openid in
	     <foreach collection="list" item="member" index="index" open="("  separator="," close=")">
				<![CDATA[
					#{member.openid}
				]]>
			</foreach>
	      ) b group by b.openid, b.name,b.createDate
	</select>


	<select id="myInfoGains" resultMap="MyInfoGains" parameterType="com.qisen.mts.spa.model.entity.SpaMyInfoGains">
		<![CDATA[
        	select * from member where appid=#{appid} and openid = #{openid} and eid=#{eid}
        ]]>
	</select>
	<resultMap type="com.qisen.mts.spa.model.entity.SpaMyInfoGains"
		id="MyInfoGains">
		<result property="myMoney" column="balance" />
		<association property="todayPeople" column="appid" javaType="int" select="getTodayPeople" />
	<association property="todayMoney" column="openid" select="getTodayMoney" />
		<association property="myPeople" column="appid" select="getMyPeople" />
	</resultMap>
	<select id="getTodayPeople" parameterType="com.qisen.mts.spa.model.entity.SpaMyInfoGains" resultType="int">
	    <![CDATA[
        	select count(id) from member where appid=#{appid}  and openid = #{openid}
        ]]>
	</select>
	<select id="getMyPeople" parameterType="com.qisen.mts.spa.model.entity.SpaMyInfoGains" resultType="int">
    	<![CDATA[
        	select count(id) from member where appid=#{appid} and recommendOneId = #{openid}
        ]]>
	</select>
	<select id="getTodayMoney" parameterType="com.qisen.mts.spa.model.entity.SpaMyInfoGains" resultType="int">
    	<![CDATA[
        	select sum(money) from incomeDetails where appid=#{appid} and openid = #{openid}and createTime > #{createTime} 
        ]]>
	</select>
</mapper>
